{% extends "base.html" %}

{% block title %}Help - StudyBox{% endblock %}

{% block content %}
<div class="container mt-5">
	<div class="row justify-content-center">
		<div class="col-lg-10 col-xl-8">
			<h2 class="text-center mb-4 text-white">Get Help</h2>
			<div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
				<button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#reportForm" aria-expanded="false" aria-controls="reportForm">Make a report/request</button>
			</div>

			<form class="mb-4" method="get" action="{{ url_for('help_page') }}">
				<div class="input-group">
					<input type="text" class="form-control" name="q" placeholder="Search FAQs by keywords" value="{{ q or '' }}">
					<button class="btn btn-outline-secondary" type="submit">Search</button>
					{% if q %}
					<a class="btn btn-outline-dark" href="{{ url_for('help_page') }}">Clear</a>
					{% endif %}
				</div>
			</form>

			<div id="reportForm" class="card mb-4 collapse">
				<div class="card-body">
					<h5 class="card-title mb-3">Create a Support Ticket</h5>
					<form method="post" enctype="multipart/form-data">
						<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
						<div class="mb-3">
							<label class="form-label">Subject</label>
							<input name="subject" type="text" class="form-control" placeholder="Brief title for your issue" required>
						</div>
						<div class="mb-3">
							<label class="form-label">Details</label>
							<textarea name="message" class="form-control" rows="5" placeholder="Describe the issue with steps or screenshots" required></textarea>
						</div>
						<div class="mb-3">
							<label class="form-label">Attach image (optional)</label>
							<input name="image" type="file" accept="image/*" class="form-control">
							<div class="form-text">Supported: PNG, JPG, JPEG, GIF, WEBP. Max 8MB.</div>
						</div>
						<div class="form-check mb-3">
							<input class="form-check-input" type="checkbox" id="add_to_faq" name="add_to_faq">
							<label class="form-check-label" for="add_to_faq">Add this to FAQ (make my question public)</label>
						</div>
						<div class="d-flex gap-2">
							<button type="submit" class="btn btn-primary">Submit Ticket</button>
							<a class="btn btn-outline-secondary" href="mailto:admin@study-box.site?subject=StudyBox%20Support">Email Support</a>
						</div>
					</form>
				</div>
			</div>

			<h5 class="text-white">FAQs</h5>
			{% if faq_tickets and faq_tickets|length > 0 %}
			<div class="accordion mb-5" id="faqListInline">
				{% for t in faq_tickets %}
				<div class="accordion-item">
					<h2 class="accordion-header" id="faq-head-{{ t.id }}-inline">
						<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq-body-{{ t.id }}-inline" aria-expanded="false" aria-controls="faq-body-{{ t.id }}-inline">
							{{ t.subject }}
						</button>
					</h2>
					<div id="faq-body-{{ t.id }}-inline" class="accordion-collapse collapse" aria-labelledby="faq-head-{{ t.id }}-inline" data-bs-parent="#faqListInline">
						<div class="accordion-body">
							<div class="mb-2">{{ t.message }}</div>
							{% if t.image_url %}
							<div class="mb-3">
								<a href="{{ t.image_url }}" target="_blank">
									<img src="{{ t.image_url }}" alt="attachment" class="img-fluid rounded" style="max-height: 260px;">
								</a>
							</div>
							{% endif %}
							{% if t.replies and t.replies|length > 0 %}
							<div class="p-3 rounded" style="background:#f8f9fa;">
								<div class="mb-2 fw-semibold">Answer</div>
								<div>{{ t.replies[0].message }}</div>
							</div>
							{% endif %}
						</div>
					</div>
				</div>
				{% endfor %}
			</div>

			<nav aria-label="FAQ pages" class="mb-4">
				<ul class="pagination justify-content-center">
					{% set total_pages = faq_pages or 1 %}
					{% set current = faq_page_num or 1 %}
					{% set start = 1 %}
					{% set end = total_pages if total_pages <= 10 else 10 %}
					{% for page in range(start, end + 1) %}
					<li class="page-item {% if page == current %}active{% endif %}">
						<a class="page-link" href="{{ url_for('help_page', q=q, page=page) }}">{{ page }}</a>
					</li>
					{% endfor %}
					{% if current < total_pages %}
					<li class="page-item">
						<a class="page-link" href="{{ url_for('help_page', q=q, page=current+1) }}">Next</a>
					</li>
					{% endif %}
				</ul>
			</nav>
			{% else %}
			<div class="card mb-5">
				<div class="card-body text-center text-muted">No FAQ items found{% if q %} for "{{ q }}"{% endif %}.</div>
			</div>
			{% endif %}

			<h5 class="text-white">Your Tickets</h5>
			{% if tickets and tickets|length > 0 %}
			<div class="list-group mb-5">
				{% for t in tickets %}
				<div class="list-group-item">
					<div class="d-flex justify-content-between align-items-start">
						<div>
							<div class="fw-semibold">{{ t.subject }}</div>
							<div class="small text-muted">{{ t.created_at.strftime('%Y-%m-%d %H:%M') if t.created_at else '' }}</div>
						</div>
						{% if t.add_to_faq %}
						<span class="badge bg-info text-dark">FAQ</span>
						{% endif %}
					</div>
					<div class="mt-2">{{ t.message }}</div>
					{% if t.image_url %}
					<div class="mt-2">
						<a href="{{ t.image_url }}" target="_blank">
							<img src="{{ t.image_url }}" alt="attachment" class="img-fluid rounded" style="max-height: 240px;">
						</a>
					</div>
					{% endif %}
					{% if t.replies and t.replies|length > 0 %}
					<div class="mt-3 p-3 rounded" style="background:#f8f9fa;">
						<div class="mb-2 fw-semibold">Admin replies</div>
						{% for r in t.replies %}
						<div class="mb-2">
							<div class="small text-muted">{{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else '' }}</div>
							<div>{{ r.message }}</div>
						</div>
						{% endfor %}
					</div>
					{% else %}
					<div class="mt-3 small text-muted">No reply yet.</div>
					{% endif %}
				</div>
				{% endfor %}
			</div>
			{% else %}
			<div class="card">
				<div class="card-body text-center text-muted">No tickets yet. Create one above.</div>
			</div>
			{% endif %}
		</div>
	</div>
</div>
{% endblock %}