{% extends "base.html" %}

{% block title %}StudyBox - Register{% endblock %}

{% block extra_css %}
<style>
.avatar-selection {
    cursor: pointer;
    display: block;
}

.avatar-img {
    border: 2px solid transparent;
}

/* Selected state styling */
input[type="radio"]:checked + .avatar-selection .avatar-img {
    border: 2px solid #007bff;
}

/* Fallback for browsers that don't support :has() */
.avatar-selection.selected .avatar-img {
    border: 2px solid #007bff;
}
</style>
{% endblock %}

{% block content %}
<div class="container d-flex align-items-center justify-content-center" style="min-height: 80vh;">
    <div class="row justify-content-center w-100">
        <div class="col-md-5 col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Sign Up</h2>
                    
                    {% if success_message %}
                        <div class="alert alert-success mb-3" role="alert">
                            {{ success_message }}
                        </div>
                    {% endif %}
                    
                    <form action="/register" method="POST">
                        {{ form.hidden_tag() }}
                        
                        <!-- Avatar Selection -->
                        <div class="mb-4">
                            <label class="form-label">Choose Avatar</label>
                            <div class="row">
                                {% for value, label in form.avatar.choices %}
                                <div class="col-6 col-md-4 col-lg-3 mb-3">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input d-none" type="radio" name="avatar" id="avatar{{ value }}" value="{{ value }}" {% if form.avatar.data == value %}checked{% endif %}>
                                        <label class="form-check-label avatar-selection" for="avatar{{ value }}">
                                            <img src="{{ custom_avatar_url(value, 60) }}" alt="Avatar {{ value }}" class="rounded-circle avatar-img" width="60" height="60">
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if form.avatar.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.avatar.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Username Field -->
                        <div class="mb-3">
                            {{ form.username(class="form-control", placeholder="Username", autocapitalize="none", autocomplete="username", spellcheck="false", style="text-transform: lowercase;" ) }}
                            {% if form.username.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.username.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <script>
                            (function(){
                              const el = document.querySelector('input[name="username"]');
                              if(el){ el.addEventListener('input', function(){ this.value = this.value.toLowerCase(); }); }
                            })();
                            </script>
                        </div>
                        
                        <!-- Email Field -->
                        <div class="mb-3">
                            {{ form.email(class="form-control", placeholder="Email", id="email_field") }}
                            {% if form.email.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.email.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Password Field -->
                        <div class="mb-3">
                            <style>
                            .password-toggle-wrap { position: relative; }
                            .password-toggle-btn {
                                position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
                                border: none; background: transparent; padding: 6px; cursor: pointer;
                                color: #6c757d;
                                transition: transform 160ms ease, color 160ms ease;
                            }
                            .password-toggle-btn:active { transform: translateY(-50%) scale(0.92); }
                            .reveal-anim { animation: pulse-reveal 180ms ease; }
                            @keyframes pulse-reveal {
                                0% { transform: scale(0.98); }
                                60% { transform: scale(1.02); }
                                100% { transform: scale(1); }
                            }
                            </style>
                            <div class="password-toggle-wrap">
                                {{ form.password(class="form-control", placeholder="Password", id="register_password") }}
                                <button type="button" class="password-toggle-btn" id="toggle_register_password" aria-label="Show password">
                                    <i class="far fa-eye" id="register_eye"></i>
                                </button>
                            </div>
                            {% if form.password.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.password.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <script>
                            (function(){
                                const input = document.getElementById('register_password');
                                const btn = document.getElementById('toggle_register_password');
                                const eye = document.getElementById('register_eye');
                                if(btn && input && eye){
                                    btn.addEventListener('click', function(){
                                        const isHidden = input.getAttribute('type') === 'password';
                                        input.setAttribute('type', isHidden ? 'text' : 'password');
                                        eye.classList.toggle('fa-eye');
                                        eye.classList.toggle('fa-eye-slash');
                                        input.classList.remove('reveal-anim');
                                        void input.offsetWidth; // restart animation
                                        input.classList.add('reveal-anim');
                                        btn.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
                                    });
                                }
                            })();
                            </script>
                        </div>
                        
                        <!-- University Field -->
                        <div class="mb-4">
                            {{ form.school_university(class="form-control", placeholder="School/University Name", id="university_field") }}
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="mb-4">
                            {{ form.submit(class="btn btn-primary w-100") }}
                        </div>
                        <p class="text-center">Already have an account? <a href="/login">Sign In</a></p>
                    </form>
                    
                    <script>
                        // Auto-detect MMU university when email is entered
                        document.getElementById('email_field').addEventListener('input', function() {
                            const email = this.value.toLowerCase();
                            const universityField = document.getElementById('university_field');
                            
                            if (email.endsWith('@student.mmu.edu.my')) {
                                universityField.value = 'Multimedia University Malaysia';
                                universityField.readOnly = true;
                                universityField.style.backgroundColor = '#f8f9fa';
                                universityField.title = 'University automatically detected from MMU email';
                            } else {
                                universityField.readOnly = false;
                                universityField.style.backgroundColor = '';
                                universityField.title = '';
                            }
                        });
                    </script>
                    
                    <script>
                        // Handle avatar selection visual feedback
                        document.addEventListener('DOMContentLoaded', function() {
                            const avatarInputs = document.querySelectorAll('input[name="avatar"]');
                            
                            avatarInputs.forEach(input => {
                                const label = input.nextElementSibling;
                                
                                // Add selected class if this avatar is pre-selected
                                if (input.checked) {
                                    label.classList.add('selected');
                                }
                                
                                // Handle click events
                                input.addEventListener('change', function() {
                                    // Remove selected class from all labels
                                    document.querySelectorAll('.avatar-selection').forEach(l => l.classList.remove('selected'));
                                    
                                    // Add selected class to the clicked label
                                    if (this.checked) {
                                        label.classList.add('selected');
                                    }
                                });
                                
                                // Handle label clicks and touch events for mobile
                                label.addEventListener('click', function(e) {
                                    // Don't prevent default - let the form handle submission naturally
                                    input.checked = true;
                                    input.dispatchEvent(new Event('change'));
                                });
                                
                                // Add touch event handling for better mobile support
                                label.addEventListener('touchstart', function(e) {
                                    input.checked = true;
                                    input.dispatchEvent(new Event('change'));
                                });
                            });
                        });
                    </script>
                </div>
            </div>
            <div class="text-center mt-4">
                <a href="/help" class="text-white text-decoration-none small">Having troubles? Click <span class="text-decoration-underline" style="color: #87CEEB;">here</span> for help</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}