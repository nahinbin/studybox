{% extends "base.html" %}

{% block title %}Community - StudyBox{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h2 class="text-center mb-4 text-white">Community</h2>

            <!-- Post form-->
            {% if current_user.is_authenticated %}
                <div class="d-flex justify-content-end mb-2">
                    <button id="togglePostFormBtn" type="button" class="btn btn-outline-primary btn-sm">Make a post</button>
                </div>
                <div id="postFormWrap" style="display: none;" class="mb-4">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            {{ form.content(class="form-control") }}
                            {% if form.content.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.content.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.post_type(class="form-select") }}
                                {% if form.post_type.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.post_type.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-end">
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
                <script>
                (function(){
                    const btn = document.getElementById('togglePostFormBtn');
                    const wrap = document.getElementById('postFormWrap');
                    if(btn && wrap){
                        btn.addEventListener('click', function(){
                            const hidden = wrap.style.display === 'none';
                            wrap.style.display = hidden ? 'block' : 'none';
                            btn.textContent = hidden ? 'Hide post form' : 'Make a post';
                            if(hidden){
                                const ta = wrap.querySelector('textarea');
                                if(ta){ ta.focus(); }
                            }
                        });
                    }
                })();
                </script>
            {% else %}
                <p class="mb-4 text-center">Please <a href="/login">sign in</a> to post.</p>
            {% endif %}

            <!-- likes/comments-->
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                const likeButtons = document.querySelectorAll('.like-btn');
                likeButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const postId = this.dataset.postId;
                        const likeCountSpan = this.querySelector('.like-count');
                        
                        fetch(`/community/post/${postId}/like`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            likeCountSpan.textContent = data.count;
                            const heartIcon = this.querySelector('i');
                            if (data.liked) {
                                heartIcon.className = 'fas fa-heart';
                            } else {
                                heartIcon.className = 'far fa-heart';
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                });

                // comments
                const commentToggles = document.querySelectorAll('.comments-toggle');
                commentToggles.forEach(toggle => {
                    toggle.addEventListener('click', function() {
                        const postId = this.dataset.postId;
                        const commentsSection = document.getElementById(`comments-${postId}`);
                        
                        if (commentsSection.style.display === 'none') {
                            // Show comments
                            commentsSection.style.display = 'block';
                        } else {
                            // Hide comments
                            commentsSection.style.display = 'none';
                        }
                    });
                });

                // comment form submissions
                const commentForms = document.querySelectorAll('form[action*="/comment"]');
                commentForms.forEach(form => {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const formData = new FormData(this);
                        const postId = this.action.split('/').pop();
                        
                        fetch(this.action, {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => {
                            if (response.ok) {
                                window.location.reload();
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                });

                function deletePost(postId) {
                    if (confirm('Are you sure you want to delete this post?')) {
                        fetch(`/community/post/${postId}/delete`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        })
                        .then(response => {
                            console.log('Delete response status:', response.status);
                            if (response.ok) {
                                window.location.reload();
                            } else {
                                alert(`Failed to delete post. Status: ${response.status}`);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Failed to delete post: ' + error.message);
                        });
                    }
                }
            });
            </script>

            <!-- Posts feed -->
            {% if posts %}
                {% for post in posts %}
                <div class="card mb-3" {% if post.post_type == 'mmu' %}style="background-color: #f0e6ff;"{% endif %}>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center gap-1">
                                <a class="text-decoration-none" href="{{ url_for('profiles.public_profile_by_public_code', code=post.user.public_id[2:]) }}">
                                    <strong>@{{ post.user.username }}</strong>
                                </a>
                                {% if post.user.is_admin %}
                                    <img src="{{ url_for('static', filename='images/admin_verified.png') }}?v={{ cache_bust_version() }}" alt="Admin" title="Admin Account" style="height:14px; width:auto; position: relative; top: 1px;">
                                {% endif %}
                                {% if post.user.is_verified %}
                                    <img src="{{ url_for('static', filename='images/verified.png') }}?v={{ cache_bust_version() }}" alt="Verified" title="Verified Account" style="height:14px; width:auto; position: relative; top: 1px;">
                                {% endif %}
                                {% if post.user.is_verified and (post.user.email and post.user.email.endswith('@student.mmu.edu.my')) %}
                                    <img src="{{ url_for('static', filename='images/mmu_fav.png') }}?v={{ cache_bust_version() }}" alt="MMU" title="Multimedia University Malaysia" style="height:14px; width:auto; position: relative; top: 1px;">
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ format_relative_time(post.created_at) }}</small>
                        </div>
                        <div class="mt-2" style="white-space: pre-wrap;">{{ post.content }}</div>
                        <div class="mt-3 d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center gap-3">
                                {% if current_user.is_authenticated %}
                                    {% set user_liked = false %}
                                    {% for like in post.likes %}
                                        {% if like.user_id == current_user.id %}
                                            {% set user_liked = true %}
                                        {% endif %}
                                    {% endfor %}
                                    <span class="like-btn text-muted" data-post-id="{{ post.id }}" style="cursor: pointer;">
                                        <i class="{% if user_liked %}fas{% else %}far{% endif %} fa-heart"></i> <span class="like-count">{{ post.likes|length }}</span>
                                    </span>
                                {% else %}
                                    <span class="text-muted">
                                        <i class="far fa-heart"></i> {{ post.likes|length }}
                                    </span>
                                {% endif %}
                                
                                <span class="comments-toggle text-muted" data-post-id="{{ post.id }}" style="cursor: pointer;">
                                    <i class="far fa-comment"></i> <span class="comment-count">{{ post.comments|length }}</span>
                                </span>
                            </div>
                            
                            {% if current_user.is_authenticated and (current_user.id == post.user_id or current_user.is_admin) %}
                                <div class="dropdown">
                                    <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="border: none; background: none;">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item text-danger" href="/community/post/{{ post.id }}/delete" onclick="return confirm('Are you sure?')">Delete</a></li>
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Comments dropdown -->
                        <div id="comments-{{ post.id }}" class="comments-section mt-3" style="display: none;">
                            <div class="border-top pt-3">
                                <!-- Comments list -->
                                <div class="comments-list mb-3" id="comments-list-{{ post.id }}">
                                    {% if post.comments %}
                                        {% for comment in post.comments %}
                                        <div class="mb-2 p-2 bg-light rounded">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <strong class="small">@{{ comment.user.username }}</strong>
                                                    <div class="small mt-1">{{ comment.content }}</div>
                                                </div>
                                                <small class="text-muted">{{ format_relative_time(comment.created_at) }}</small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted small">No comments yet.</p>
                                    {% endif %}
                                </div>
                                
                                <!-- Comment form -->
                                {% if current_user.is_authenticated %}
                                <form method="POST" action="{{ url_for('add_comment', post_id=post.id) }}">
                                    {{ form.hidden_tag() }}
                                    <div class="input-group">
                                        <textarea name="content" class="form-control" placeholder="Write a comment..." rows="2" required></textarea>
                                        <button type="submit" class="btn btn-outline-primary">Comment</button>
                                    </div>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="card">
                    <div class="card-body text-center">
                        <p class="mb-0 text-muted">No posts yet. Be the first to share something!</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
