{% extends 'base.html' %}
{% block title %}Admin - StudyBox{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4 text-center text-white">Admin</h1>


    {% if page == 'dashboard' %}
    <div class="row g-3 mb-4 mx-auto" style="max-width: 900px;">
        <div class="col-md-4">
            <a class="text-decoration-none" href="{{ url_for('admin_dashboard', filter='all') }}">
                <div class="card rounded-3">
                    <div class="card-body">
                        <h5 class="card-title">Total Users</h5>
                        <p class="display-6">{{ total_users }}</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a class="text-decoration-none" href="{{ url_for('admin_dashboard', filter='verified') }}">
                <div class="card rounded-3">
                    <div class="card-body">
                        <h5 class="card-title">Verified Users</h5>
                        <p class="display-6">{{ verified_users }}</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a class="text-decoration-none" href="{{ url_for('admin_dashboard', filter='mmu') }}">
                <div class="card rounded-3">
                    <div class="card-body">
                        <h5 class="card-title">MMU Users</h5>
                        <p class="display-6">{{ mmu_users }}</p>
                    </div>
                </div>
            </a>
        </div>
        
    </div>

    <h4 class="text-center text-white">
        {% if active_filter == 'verified' %}
            Verified Users
        {% elif active_filter == 'mmu' %}
            MMU Users
        {% elif active_filter == 'admins' %}
            Admins
        {% else %}
            Users
        {% endif %}
    </h4>
    <form method="get" action="{{ url_for('admin_dashboard') }}" class="mb-3 mx-auto" style="max-width: 900px;">
        <div class="input-group">
            <input type="text" class="form-control" name="q" placeholder="Search by username, email, or institution" value="{{ q or '' }}">
            <button class="btn btn-outline-secondary" type="submit">Search</button>
            {% if q %}
            <a class="btn btn-outline-dark" href="{{ url_for('admin_dashboard', filter=active_filter) }}">Clear</a>
            {% endif %}
        </div>
    </form>
    <div class="list-group rounded-3 mx-auto" style="max-width: 900px;">
        {% for u in users %}
        <div class="list-group-item list-group-item-action" data-bs-toggle="collapse" data-bs-target="#user-{{ u.id }}" aria-expanded="false" aria-controls="user-{{ u.id }}">
            <div class="d-flex justify-content-between align-items-center">
                <a class="d-flex align-items-center gap-2 text-decoration-none admin-user-link" href="{{ url_for('profiles.public_profile_by_public_code', code=u.public_id[2:]) }}">
                    <img src="{{ user_avatar_url(u, 24) }}" alt="Avatar" class="rounded-circle" width="24" height="24">
                    <span class="fw-semibold">@{{ u.username }}</span>
                    {% if u.is_admin %}
                        <img src="/static/images/admin_verified.png" alt="Admin" title="Admin Account" style="height:16px; width:auto;">
                    {% endif %}
                </a>
                <span>
                    {% if u.is_verified and (u.email and u.email.endswith('@student.mmu.edu.my')) %}
                        <img src="/static/images/mmu_fav.png" alt="MMU" title="Multimedia University Malaysia" style="height:20px; width:auto;">
                    {% else %}
                        <span title="{{ u.school_university or 'Not specified' }}">{{ u.school_university or 'Not specified' }}</span>
                    {% endif %}
                </span>
            </div>
        </div>
        <div class="collapse {% if request.args.get('open_id') and request.args.get('open_id')|int == u.id %}show{% endif %}" id="user-{{ u.id }}">
            <div class="card card-body border-0 border-top">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="small text-muted">User ID</div>
                        <div><a href="{{ url_for('profiles.public_profile_by_public_code', code=u.public_id[2:]) }}">{{ u.public_id }}</a></div>
                    </div>
                    <div class="col-md-3">
                        <div class="small text-muted">Username</div>
                        <div>@{{ u.username }}</div>
                    </div>
                    <div class="col-md-3">
                        <div class="small text-muted">Email</div>
                        <div>
                            {% if u.is_verified %}
                                {{ u.email }}
                            {% else %}
                                <span class="text-muted">Not verified</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="small text-muted">Institution</div>
                        <div>{{ u.school_university or 'Not specified' }}</div>
                    </div>
                    <div class="col-md-3">
                        <div class="small text-muted">Verified</div>
                        <div>
                            {% if u.is_verified %}
                                <img src="/static/images/verified.png" alt="Verified" title="Verified Account" style="height:20px; width:auto;">
                            {% else %}
                                No
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="small text-muted">Role</div>
                        <div>
                            {% if u.username == 'admin' %}
                                <span class="d-flex align-items-center gap-1">
                                    Admin
                                    <img src="/static/images/admin_verified.png" alt="Admin" title="Admin Account" style="height:16px; width:auto;">
                                </span>
                            {% else %}
                                User
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            {% if u.id != current_user.id %}
                            <form method="post" action="{{ url_for('admin_delete_user', user_id=u.id) }}" onsubmit="return confirm('Remove user {{ u.username }}? This action cannot be undone.')">
                                <input type="hidden" name="filter" value="{{ active_filter or 'all' }}">
                                <input type="hidden" name="q" value="{{ q or '' }}">
                                <input type="hidden" name="page" value="{{ page or 'users' }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Remove user</button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% if request.args.get('open_id') %}
    <script>
    (function () {
        var openId = "{{ request.args.get('open_id') or '' }}";
        if (openId) {
            var el = document.getElementById('users-' + openId);
            if (el) {
                var collapse = new bootstrap.Collapse(el, { toggle: false });
                collapse.show();
                // scroll into view for better UX
                setTimeout(function(){ el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
            }
        }
    })();
    </script>
    {% endif %}
    {% endif %}

    {% if page == 'users' %}
    <h4 class="text-center text-white">
        {% if active_filter == 'verified' %}
            Verified Users
        {% elif active_filter == 'admins' %}
            Admins
        {% else %}
            All Users
        {% endif %}
    </h4>
    <form method="get" action="{{ url_for('admin_users') }}" class="mb-3 mx-auto" style="max-width: 900px;">
        <div class="input-group">
            <input type="text" class="form-control" name="q" placeholder="Search by username, email, or institution" value="{{ q or '' }}">
            <input type="hidden" name="filter" value="{{ active_filter or 'all' }}">
            <button class="btn btn-outline-secondary" type="submit">Search</button>
            {% if q %}
            <a class="btn btn-outline-dark" href="{{ url_for('admin_users', filter=active_filter) }}">Clear</a>
            {% endif %}
        </div>
    </form>
    <div class="list-group rounded-3 mx-auto" style="max-width: 900px;">
        {% for u in users %}
        <div class="list-group-item list-group-item-action" data-bs-toggle="collapse" data-bs-target="#users-{{ u.id }}" aria-expanded="false" aria-controls="users-{{ u.id }}">
            <div class="d-flex justify-content-between align-items-center">
                <a class="d-flex align-items-center gap-2 text-decoration-none admin-user-link" href="{{ url_for('profiles.public_profile_by_public_code', code=u.public_id[2:]) }}">
                    <img src="{{ user_avatar_url(u, 24) }}" alt="Avatar" class="rounded-circle" width="24" height="24">
                    <span class="fw-semibold">@{{ u.username }}</span>
                    {% if u.is_admin %}
                        <img src="/static/images/admin_verified.png" alt="Admin" title="Admin Account" style="height:16px; width:auto;">
                    {% endif %}
                </a>
                <span>
                    {% if u.is_verified and (u.email and u.email.endswith('@student.mmu.edu.my')) %}
                        <img src="/static/images/mmu_fav.png" alt="MMU" title="Multimedia University Malaysia" style="height:20px; width:auto;">
                    {% else %}
                        <span title="{{ u.school_university or 'Not specified' }}">{{ u.school_university or 'Not specified' }}</span>
                    {% endif %}
                </span>
            </div>
        </div>
        <div class="collapse {% if request.args.get('open_id') and request.args.get('open_id')|int == u.id %}show{% endif %}" id="users-{{ u.id }}">
            <div class="card card-body border-0 border-top">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="small text-muted">User ID</div>
                        <div><a href="{{ url_for('profiles.public_profile_by_public_code', code=u.public_id[2:]) }}">{{ u.public_id }}</a></div>
                    </div>
                    <div class="col-md-3">
                        <div class="small text-muted">Username</div>
                        <div>@{{ u.username }}</div>
                    </div>
                    <div class="col-md-3">
                        <div class="small text-muted">Email</div>
                        <div>
                            {% if u.is_verified %}
                                {{ u.email }}
                            {% else %}
                                <span class="text-muted">Not verified</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="small text-muted">Institution</div>
                        <div>{{ u.school_university or 'Not specified' }}</div>
                    </div>
                    <div class="col-md-3">
                        <div class="small text-muted">Verified</div>
                        <div>
                            {% if u.is_verified %}
                                <img src="/static/images/verified.png" alt="Verified" title="Verified Account" style="height:20px; width:auto;">
                            {% else %}
                                No
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="small text-muted">Role</div>
                        <div>
                            {% if u.username == 'admin' %}
                                <span class="d-flex align-items-center gap-1">
                                    Admin
                                    <img src="/static/images/admin_verified.png" alt="Admin" title="Admin Account" style="height:16px; width:auto;">
                                </span>
                            {% else %}
                                User
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            {% if u.id != current_user.id %}
                            <form method="post" action="{{ url_for('admin_delete_user', user_id=u.id) }}" onsubmit="return confirm('Remove user {{ u.username }}? This action cannot be undone.')">
                                <input type="hidden" name="filter" value="{{ active_filter or 'all' }}">
                                <input type="hidden" name="q" value="{{ q or '' }}">
                                <input type="hidden" name="page" value="{{ page or 'users' }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Remove user</button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}


