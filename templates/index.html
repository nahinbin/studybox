{% extends "base.html" %}

{% block title %}StudyBox Dashboard{% endblock %}

{% block content %}
<!-- Dashboard Warnings Section -->
{% if warnings %}
<div class="container mt-3">
    <div class="row">
        <div class="col-12">
            <div id="warningsCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for warning in warnings %}
                    <div class="carousel-item {% if loop.first %}active{% endif %}" data-type="{{ warning.type }}" data-urgency="{{ warning.urgency }}">
                        <div class="alert alert-{{ warning.urgency|replace('critical', 'danger')|replace('urgent', 'warning')|replace('warning', 'warning')|replace('info', 'info') }} alert-dismissible fade show mb-0" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="{{ warning.icon }} me-3 fs-4"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1">{{ warning.title }}</h6>
                                    <p class="mb-0 small">{{ warning.message }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if warnings|length > 1 %}
                <div class="carousel-indicators">
                    {% for warning in warnings %}
                    <button type="button" data-bs-target="#warningsCarousel" data-bs-slide-to="{{ loop.index0 }}" {% if loop.first %}class="active" aria-current="true"{% endif %} aria-label="Warning {{ loop.index }}"></button>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- No warnings message -->
<div class="container mt-3">
    <div class="row">
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show mb-0" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-3 fs-4"></i>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-1">All Good!</h6>
                        <p class="mb-0 small">No urgent notifications at the moment. Keep up the great work!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<section class="dashboard-cards">
    <div class="container">
        <div class="row g-4">
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="dashboard-card course-management">
                    <!-- if the user is already enrolled in a semester take him to the enrollments page otherwise go to the semester page -->
                        {% if current_user.current_semester %}
                            {% set page = url_for('enrollment.enroll', user_id=current_user.id) %}
                        {% else %}
                            {% set page = url_for('enrollment.semesters', user_id=current_user.id) %}
                        {% endif %}
                        <a href="{{page}}" class="card-link">
                    
                            <div class="card-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="card-content">
                                <h3 class="card-title">Course Management</h3>
                                <p class="card-description">Add courses, subjects and organize your academic journey</p>
                                <div class="card-action">
                                    <span class="action-text">Manage Courses</span>
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                            </div>
                        </a>
                    
                </div>
            </div>
            
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="dashboard-card task-tracker">
                    <a href="{{ url_for('assignments.tracker_home', user_id=current_user.id) }}" class="card-link">
                        <div class="card-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Track Tasks</h3>
                            <p class="card-description">Track your assignments, coursework and stay organized</p>
                            <div class="card-action">
                                <span class="action-text">View Tasks</span>
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="dashboard-card quick-links">
                    <a href="{{ url_for('quicklinks') }}" class="card-link">
                        <div class="card-icon">
                            <i class="fas fa-bookmark"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Quick Links</h3>
                            <p class="card-description">Save and access your important websites in one place</p>
                            <div class="card-action">
                                <span class="action-text">Manage Links</span>
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="dashboard-card grade-calculator">
                    <a href="{{ url_for('gpa.calc_home', user_id=current_user.id) }}" class="card-link">
                        <div class="card-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Calculate Grades</h3>
                            <p class="card-description">Calculate your GPA/CGPA and track academic performance</p>
                            <div class="card-action">
                                <span class="action-text">Calculate GPA</span>
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="dashboard-card class-schedule">
                    <a href="{{ url_for('schedule.schedule_home') }}" class="card-link">
                        <div class="card-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Class Schedules</h3>
                            <p class="card-description">View your class timings, locations and stay on schedule</p>
                            <div class="card-action">
                                <span class="action-text">View Schedule</span>
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="dashboard-card attendance-tracker">
                    <a href="{{ url_for('assignments.tracker_home', user_id=current_user.id) }}" class="card-link">
                        <div class="card-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Track Attendance</h3>
                            <p class="card-description">Monitor attendance and get warnings when below 80%</p>
                            <div class="card-action">
                                <span class="action-text">Open Tracker</span>
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="dashboard-card community">
                    <a href="{{ url_for('community') }}" class="card-link">
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Community</h3>
                            <p class="card-description">Connect with fellow students, share updates and engage in discussions</p>
                            <div class="card-action">
                                <span class="action-text">Join Community</span>
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="dashboard-card pomodoro-timer">
                    <a href="#" class="card-link">
                        <div class="card-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Pomodoro Timer</h3>
                            <p class="card-description">Boost productivity with focused work sessions and breaks</p>
                            <div class="card-action">
                                <span class="action-text">Coming Soon</span>
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.getElementById('warningsCarousel');
    if (!carousel) return;
    
    const carouselItems = carousel.querySelectorAll('.carousel-item');
    
    if (carouselItems.length === 0) return;
    
    // Add click handlers for warning cards
    carouselItems.forEach(item => {
        let touchStartX = 0;
        let touchEndX = 0;
        
        item.addEventListener('click', function(e) {
            // Only handle click if it's not a swipe gesture
            if (Math.abs(touchStartX - touchEndX) < 50) {
                const type = this.dataset.type;
                const urgency = this.dataset.urgency;
                
                // Add visual feedback
                this.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
                
                // Handle different warning types
                switch(type) {
                    case 'assignment_deadline':
                    case 'assignment_overdue':
                        // Redirect to assignment tracker
                        window.location.href = `/assignment_tracker/?user_id={{ current_user.id }}`;
                        break;
                    case 'low_gpa':
                        // Redirect to GPA calculator
                        window.location.href = `/gpa_calculator/{{ current_user.id }}`;
                        break;
                    case 'upcoming_class':
                        // Redirect to schedule
                        window.location.href = '/schedule/';
                        break;
                    default:
                        console.log('Unknown warning type:', type);
                }
            }
        });
        
        // Add touch support for swipe gestures
        item.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
        });
        
        item.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].clientX;
        });
        
        // Add cursor pointer
        item.style.cursor = 'pointer';
    });
    
    // Update time-sensitive warnings every minute
    setInterval(function() {
        // Reload page to get updated warnings (simple approach)
        // In a production app, you'd use AJAX to fetch updated data
        const now = new Date();
        const minutes = now.getMinutes();
        
        // Only reload if we're at the start of a new minute
        if (minutes === 0 || minutes === 30) {
            // Check if there are time-sensitive warnings
            const timeSensitiveCards = document.querySelectorAll('[data-type="upcoming_class"]');
            if (timeSensitiveCards.length > 0) {
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        }
    }, 30000); // Check every 30 seconds
});
</script>
{% endblock %}